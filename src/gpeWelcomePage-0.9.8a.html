<link rel="stylesheet" href="https://scfiles.csod.com/Baseline/Config/CSS/gpeWelcomePage/gpefonts.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css">

<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css">
<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.3/dist/extensions/filter-control/bootstrap-table-filter-control.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.0.0/chartjs-plugin-datalabels.min.js"></script>

<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table-locale-all.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/extensions/export/bootstrap-table-export.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/extensions/filter-control/bootstrap-table-filter-control.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/extensions/filter-control/utils.min.js"></script>

<div class="gpewp_container" id="gpewp">
    <div class="gpewp_topcontainer" id="gpewp_top">
        <div class="gpewp_topcontainer_upper" id="gpewp_topcontainer_upper"></div>
        <div class="gpewp_topcontainer_lower" id="gpewp_topcontainer_nav"></div>
    </div>
    <div class="gpewp_maincontent" id="gpewp-main">
        <div class="tab-content gpewp_content" id="nav-tabContent">
            <div class="tab-pane fade" id="nav-USR" role="tabpanel" aria-labelledby="nav-USR-tab">
                <div class="gpewp_USR" id="USR-content">
                    <div class="gpewp_USR-right row" id="USR-right"></div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-MGR" role="tabpanel" aria-labelledby="nav-MGR-tab">
                <div class="gpewp_MGR" id="MGR-content">
                    <div class="gpewp_MGR-right" id="MGR-right"></div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-HRD" role="tabpanel" aria-labelledby="nav-HRD-tab">
                <div class="gpewp_HRD" id="HRD-content">
                    <div class="gpewp_HRD-right" id="HRD-right"></div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-INS" role="tabpanel" aria-labelledby="nav-INS-tab">
                <div class="gpewp_INS" id="INS-content">
                    <div class="gpewp_INS-right" id="INS-right"></div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-ADM" role="tabpanel" aria-labelledby="nav-ADM-tab">
                <div class="gpewp_ADM" id="ADM-content">
                    <div class="gpewp_ADM-right" id="ADM-right"></div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-REC" role="tabpanel" aria-labelledby="nav-REC-tab">
                <div class="gpewp_REC" id="REC-content">
                    <div class="gpewp_REC-right" id="REC-right"></div>
                </div>
            </div>
        </div>
    </div>

</div>
<div id="demopersona" class="hidden" demopersona="{GPE.DEMOCONFIGPERSONA}"></div>
<div id="demomodules" class="hidden" demomodules="{GPE.DEMOCONFIGMODULES}"></div>
<div id="demovisuals" class="hidden" demovisuals="{GPE.WPBRANDING}"></div>
<div id="demousername" class="hidden" demousername="{FIRSTNAME};{LASTNAME}"></div>

<script type="text/javascript">
/**
 * rgbToHsl - make RBG to HSL which is being used for banner gradients. It can also be used to lighten/darken the return.
 * @param {string} rgbARg - rgb string rgb(1,2,3).
 * @param {string} lightnessArg - array to add/remove saturation of the given color.
 * @returns {string} HSL(1,2,3) which is then being used in gradient css.
 */
function rgbToHsl(rgbARg, lightnessArg) {
    rgb = rgbARg.substring(4, rgbARg.length - 1)
        .replace(/ /g, '')
        .split(',');
    r = rgb[0];
    g = rgb[1];
    b = rgb[2];

    r /= 255, g /= 255, b /= 255;
    var max = Math.max(r, g, b),
        min = Math.min(r, g, b);
    var h, s, l = (max + min) / 2;

    if (max == min) {
        h = s = 0;
    } else {
        var d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
            case r:
                h = (g - b) / d + (g < b ? 6 : 0);
                break;
            case g:
                h = (b - r) / d + 2;
                break;
            case b:
                h = (r - g) / d + 4;
                break;
        }
        h /= 6;
    }
    return "hsl(" + Math.floor(h * 360) + "," + Math.floor(s * 100) + "%," + Math.floor(l * 100 + lightnessArg) + "%)";
}

/**
 * checkRandomCustomBG - Load 50 random images from unsplash and store in sessionStorage if sessionStorage is empty.
 * @param {array} tmpArrayArg - Array of URL
 * @param {string} elementArg -
 * @returns {boolean} true (lazy, yeah... I know)
 */
function checkRandomCustomBG() {
    if (!sessionStorage["csBackgroundJSON"]) {
        return fetch('https://unsplash.com/ngetty/v3/search/images/creative?' + new URLSearchParams({
                fields: "display_set,referral_destinations,title",
                page_size: "50",
                phrase: "customer care office organisation",
                sort_order: "best_match",
                graphical_styles: "photography",
                exclude_nudity: "true",
                exclude_editorial_use_only: "true"
            }), {
                method: 'GET',
                mode: 'cors',
                cache: 'no-cache',

            })
            .then(response => response.json())
            .then(partResp => {
                const tmpArr = [];
                for (let imageIndex in partResp.images) {
                    tmpArr[imageIndex] = partResp.images[imageIndex].display_sizes[3].uri;
                }
                return tmpArr;
            })
            .then(tmpArray => {
                sessionStorage.setItem("csBackgroundJSON", JSON.stringify(tmpArray));
                return tmpArray;
                // setRandomCustomBG(tmpArray, "html");
            })
            .catch(error => {
                console.error(error);
            });
    } else {
        return JSON.parse(sessionStorage["csBackgroundJSON"]);
    }
}

/**
 * IsJsonString - Returns branding details from user record custom field specified in the arguments.
 * @param {string} brandingDivArg
 * @returns {array} Array to be used to set banner background and primary colors.
 */
function IsJsonString(strArg) {
    try {
        JSON.parse(strArg);
    } catch (e) {
        return false;
    }
    return true;
}

/**
 * getBrandingDetails - Returns branding details from user record custom field specified in the arguments.
 * @param {string} brandingDivArg
 * @returns {array} Array to be used to set banner background and primary colors.
 */
function getBrandingDetails(brandingDivArg) {
    const brandingStr = document.getElementById(brandingDivArg).getAttribute(brandingDivArg);
    const brandingArr = (IsJsonString(brandingStr)) ? JSON.parse(brandingStr) : {
        TopBannerImage: "",
        UserHeaderColor: "",
        FontColor: ""
    };
    return brandingArr;
}

/**
 * fileExists - Returns true/false depending on if image exists or not.
 * @param {string} fileUrl
 * @returns {boolean} true if image exists.
 */
function checkIfImageExists(url, callback) {
    const img = new Image();
    img.src = url;

    if (img.complete) {
        callback(true);
    } else {
        img.onload = () => {
            callback(true);
        };

        img.onerror = () => {
            callback(false);
        };
    }
}

/**
 * updateWelcomePage - Final update on welcome page banner and primary color css
 * @param {string} cssPrimaryArg - primary colour to be used on banner.
 * @param {array} topBannerImgURLArg - Array of either an image url OR several image URLs
 * @param {string} randomArg - 0 = do not randomise, 1 = do randomise
 * @returns {boolean} true if image exists.
 */
function setBgImage(topBannerImgURLArg) {
    var cssUpdateStr = "linear-gradient(180deg, #f1f1f100 360px, #f1f1f1 360px), url(" + topBannerImgURLArg + ") no-repeat center center / cover";
    document.querySelector("html").style.setProperty('--gpewp-banner-background', cssUpdateStr, "important");
    return true;
}

const gpeDEMOVISUALS = "demovisuals";
const gpeBRANDING = getBrandingDetails(gpeDEMOVISUALS);

$(function() {
    // Set banner background color based on primary
    const cssPrimaryBG = $('.c-nav-user').css('background-color');
    document.querySelector('html').style.setProperty('--gpewp-brand-color--primary', cssPrimaryBG, "important");
    const cssPrimaryBG_light = rgbToHsl(cssPrimaryBG, 10)
    document.querySelector('html').style.setProperty('--gpewp-banner-bg-color--light', cssPrimaryBG_light, "important");

    $.when(gpeBRANDING)
        .then((brandingResponse) => {
            console.log(brandingResponse);
            if (brandingResponse.TopBannerImage != "") {
                console.log("Image is in Custom Field!")
                const topBannerImgURL = "https://scfiles.csod.com" + brandingResponse.TopBannerImage;
                const ProspectBG = checkIfImageExists(topBannerImgURL, (exists) => {
                    if (exists) {
                        console.log("Yes, image exists.");
                        return setBgImage(topBannerImgURL);
                    } else {
                        console.log("Nope, image really does not exist... perhaps we should set the header color?");
                    }
                })
            } else {
                console.log("Nope, image data does not exist.");
            }
            // If there is a header color...
            if(brandingResponse.UserHeaderColor != ""){
                document.getElementById('gpewp_topcontainer_upper').style.setProperty("background-color", brandingResponse.UserHeaderColor, "important");
            }
        })
})
</script>